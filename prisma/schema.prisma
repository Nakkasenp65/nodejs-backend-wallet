
generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}


enum TransactionType {
  OUTCOME  
  INCOME 
}

enum TransactionStatus {
  PENDING
  SUCCESS
  CANCELLED
  REJECTED
}

enum GoalStatus {
  ACTIVE    
  COMPLETED 
  CANCELLED 
}

enum Choice {
  DAILY 
  WEEKLY
  HALF_MONTH 
  MONTHLY 
}

enum NotificationType {
  RECEIVE
  SENT
  REWARD
  SYSTEM
}

enum UserMissionStatus {
  ENROLLED
  COMPLETED
  EXPIRED
}

model Notification {
  id        String   @id @map("_id") @default(auto()) @db.ObjectId

  title     String            
  body      String?           
  type      NotificationType  
  
  isRead    Boolean  @default(false)
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String   @db.ObjectId

  transaction   Transaction? @relation(fields: [transactionId], references: [id], onDelete: SetNull)
  transactionId String?      @db.ObjectId

  createdAt DateTime @default(now())
}

model User {
  id        String  @id @map("_id") @default(auto()) @db.ObjectId
  userId    String  @unique
  username  String
  firstTime Boolean @default(true)
  userProfilePicUrl String? 

  goal Goal?
  wallet Wallet?
  notifications     Notification[] 
  userMissions      UserMission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Wallet {
  id       String   @id @map("_id") @default(auto()) @db.ObjectId
  balance  Float    @default(0)

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @unique @db.ObjectId

  transactions Transaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Transaction {
  id            String          @id @map("_id") @default(auto()) @db.ObjectId
  name          String
  amount        Float?
  type          TransactionType
  status        TransactionStatus @default(PENDING)
  from          String
  to            String
  description   String?
  bank          String?
  createdAt     DateTime        @default(now())
  wallet        Wallet          @relation(fields: [walletId], references: [id], onDelete: Cascade)
  walletId      String          @unique @db.ObjectId
  notifications Notification[]
  userMission   UserMission?    @relation(fields: [userMissionId], references: [id], onDelete: SetNull) // Link to the completed mission
  userMissionId String?         @unique @db.ObjectId

  @@index([walletId, status, createdAt(sort: Desc)])
}

model Mission {
  id              String        @id @map("_id") @default(auto()) @db.ObjectId
  title           String
  description     String
  rewardAmount    Float
  webExpiresAt    DateTime // Expiration date for the mission on the website
  enrolledBy      UserMission[] // Relation to users who have enrolled
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
}

model UserMission {
  id        String   @id @map("_id") @default(auto()) @db.ObjectId
  
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String @db.ObjectId

  mission   Mission @relation(fields: [missionId], references: [id], onDelete: Cascade)
  missionId String  @db.ObjectId

  status          UserMissionStatus @default(ENROLLED)
  enrolledAt      DateTime          @default(now())
  userExpiresAt   DateTime // Expiration for the user to complete the mission
  completedAt     DateTime?
  rewardTransaction Transaction? // The transaction that gave the reward

  @@unique([userId, missionId]) // Ensures a user can only enroll in a mission once
}

model Goal {
  id     String     @id @map("_id") @default(auto()) @db.ObjectId
  status GoalStatus @default(ACTIVE)

  plan   Plan   @relation(fields: [planId], references: [id])
  planId String @unique @db.ObjectId

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @unique @db.ObjectId

  product   Product @relation(fields: [productId], references: [id])
  productId String  @db.ObjectId

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Plan {
  id String @id @map("_id") @default(auto()) @db.ObjectId
  name Choice
  displayName String
  goal Goal?
}

model Brand {
  id        String        @id @map("_id") @default(auto()) @db.ObjectId
  name      String        @unique
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
}

// Brand -> Model
// model MobileModel {
//   id        String @id @map("_id") @default(auto()) @db.ObjectId
//   name      String 
//   price     Float

//   brand   Brand  @relation(fields: [brandId], references: [id])
//   brandId String @db.ObjectId

  
//   targetedByGoals Goal[]

//   createdAt DateTime @default(now())
//   updatedAt DateTime @updatedAt
// }

model Product {
  id       String @id @default(auto()) @map("_id") @db.ObjectId
  uniqueId String @unique

  brand    String
  model    String
  capacity String
  color    String
  price    Int
  imageUrl String

  downPaymentAmount   Int
  downPaymentPercent  Int
  installment6Months  Int
  installment10Months Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  targetedByGoals Goal[]
}


